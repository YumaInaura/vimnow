#!/bin/bash -eu

readonly VERSION=0.2.1

readonly vimnow_path=${VIMNOW_PATH:-~/vimnow}
readonly save_dir="$vimnow_path"/save

readonly vimnow_lib_path=${VIMNOW_LIB_PATH:-}
if [ ! -z "$vimnow_lib_path" ]; then
  readonly lib_dir="$vimnow_lib_path"
else
  readonly lib_dir="$vimnow_path"/lib
fi

source "$lib_dir"/.setting

for arg in "$@"; do
  if [ "$arg" = '--version' ]; then
    echo "$VERSION"
    exit
  elif [ "$arg" = '--upgrade' ]; then
    curl 'https://raw.githubusercontent.com/yumainaura/vimnow/master/install.sh?'$((RANDOM))$((RANDOM)) | bash; echo
    exit
  elif [ "$arg" = '--list' ]; then
    find "$save_dir" -type f -maxdepth 1 | grep -v -e '/\.[a-zA-Z0-9_\.]\+$' | xargs ls -l
    exit
  elif [ "$arg" = '--path' ]; then
    echo "$save_dir"
    exit
  fi
done

mkdir -p "$save_dir"

file_extension=''
is_execute_script=false
continue_mode=false
for option in "$@"; do
  [ "$option" = '--sh' ] && file_extension='.sh' && is_execute_script=true
  [ "$option" = '--continue' ] && continue_mode=true
done

readonly specify_filename=${1:-}
if "$continue_mode"; then
  readonly filepath=$(find "$(vimnow --path)" -type f | xargs ls -t | grep -v -e '\.swp$' | head -n 1)
elif [ ! -z "$specify_filename" ] && [[ "$specify_filename" =~ ^[a-zA-Z0-9\.]+$ ]]; then
  readonly filepath="$save_dir"/"$1"
else
  readonly filepath="$save_dir"/$(date -u | sed 's/ /-/g')-$(date +%s)"$file_extension"
fi

touch "$filepath"

if "$is_execute_script"; then
  chmod 0755 "$filepath"
else
  chmod 0644 "$filepath"
fi

readonly vimnow_vim_path=${VIMNOW_VIM_PATH:-}
if [ ! -z "$vimnow_vim_path" ]; then
  eval "$vimnow_vim_path" "$filepath"
else
  vim "$filepath"
fi

if [ $(stat -c '%s' "$filepath") == 0 ]; then
  rm "$filepath"
else
  echo "$filepath"
fi
