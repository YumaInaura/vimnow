#!/bin/bash -eu

readonly VERSION=0.1.5
# For Mac OS

if [ $(uname) = 'Darwin' ]; then
  # FIXME: Ask yes or no
  which gdate >/dev/null || brew install coreutils
  function date() {
    gdate $@
  }

  # FIXME: Ask yes or no
  which gstat >/dev/null || brew install coreutils
  function stat() {
    gstat $@
  }
fi

readonly save_dir=${VIMNOW_PATH:-~/vimnow}

for arg in "$@"; do
  if [ "$arg" = '--version' ]; then
    echo "$VERSION"
    exit
  elif [ "$arg" = '--upgrade' ]; then
    curl 'https://raw.githubusercontent.com/yumainaura/vimnow/master/install.sh?'$((RANDOM))$((RANDOM)) | bash; echo
    vimnow --version
    exit
  elif [ "$arg" = '--list' ]; then
    find "$save_dir" -type f -maxdepth 1 | grep -v -e '/\.[a-zA-Z0-9_\.]\+$' | xargs ls -l
    exit
  elif [ "$arg" = '--path' ]; then
    echo "$save_dir"
    exit
  fi
done

mkdir -p "$save_dir"

file_extension=''
for option in "$@"; do
  [ "$option" = '--sh' ] && file_extension='.sh'
done

readonly filepath="$save_dir"/$(date -u | sed 's/ /-/g')-$(date +%s)"$file_extension"

touch "$filepath"
chmod 0755 "$filepath"

echo "${filepath}" > "${save_dir}/.latest_filepath"

readonly test_mode=${TEST_MODE:-false}
if "$test_mode"; then
  shopt -s expand_aliases
  alias vim="echo 'EDITED' > $filepath"
fi

vim "${filepath}"

if [ $(stat -c '%s' "$filepath") == 0 ]; then
  rm "$filepath"
else
  echo "$filepath"
fi
